<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scanner QR Code Calor Run</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    #reader { width: 80vw; margin: 20px auto; }
    #result { font-size: 4em; margin-top: 20px; color: green; }
    #lastScans { margin-top: 30px; font-size: 1.5em; }
    #lastScans ul { list-style: none; padding: 0; }
    #lastScans li { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Scanner QR Code Calor Run</h1>
  <div id="reader"></div>
  <div id="result">---</div>
  
  <div id="lastScans">
    <strong>Derniers codes scannés :</strong>
    <ul id="scanList"></ul>
  </div>

  <script>
    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.firebasestorage.app",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== Identifiant unique de l'appareil =====
    const deviceId = 'device_' + Math.floor(Math.random() * 1000000);

    // ===== File d'attente pour fiabilité =====
    const queue = [];
    let sending = false;
    const lastScans = [];

    function showResult(code) {
      const el = document.getElementById("result");
      el.innerText = code;
    }

    function updateLastScans(code) {
      const timestamp = new Date();
      lastScans.unshift({ code, time: timestamp });
      if (lastScans.length > 10) lastScans.pop();

      const ul = document.getElementById("scanList");
      ul.innerHTML = "";
      lastScans.forEach(item => {
        const li = document.createElement("li");
        li.innerText = `[${item.time.toLocaleTimeString()}] ${item.code}`;
        ul.appendChild(li);
      });
    }

    function onScanSuccess(decodedText) {
      const code = String(decodedText || "").trim();
      if (!code) return;

      queue.push({ code, timestamp: Date.now() });
      processQueue();

      showResult(code);
    }

    function processQueue() {
      if (sending || queue.length === 0) return;
      sending = true;

      const item = queue.shift();

      // Génère une clé unique pour Firebase : timestamp + deviceId + random
      const key = item.timestamp + "_" + deviceId + "_" + Math.floor(Math.random() * 1000);

      db.ref('scans/' + key).set({ code: item.code, device: deviceId })
        .then(() => console.log("Envoyé Firebase:", item.code))
        .catch(err => {
          console.error("Erreur Firebase:", err);
          queue.push(item); // réessayer
        })
        .finally(() => {
          sending = false;
          updateLastScans(item.code);
          if (queue.length > 0) processQueue();
        });
    }

    // ===== Démarrage caméra =====
    Html5Qrcode.getCameras().then(cameras => {
      if (!cameras || cameras.length === 0) return console.error("Aucune caméra détectée !");
      const rear = cameras.find(c => c.label.toLowerCase().includes("back")) || cameras[0];
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        rear.id,
        { fps: 10, qrbox: { width: 300, height: 300 }, facingMode: "environment" },
        onScanSuccess,
        err => {}
      );
    });
  </script>
</body>
</html>
