<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Synthèse Participants (Firebase)</title>
<style>
  body { font-family: system-ui, sans-serif; padding:20px; background:#f9f9f9; color:#111; }
  h1 { color:#215E99; margin-bottom:10px; }
  .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  table { width:100%; border-collapse: collapse; margin-bottom:20px; }
  th, td { border:1px solid #ddd; padding:6px 10px; text-align:center; }
  th { background:linear-gradient(135deg, #215E99 0%, #E61780 100%); color:#fff; }
  tr:nth-child(even) { background:#f2f2f2; }
  .subtotal { font-weight:bold; background:#e8f0fe; }
  .total { font-weight:bold; background:#d1ecf1; }
</style>
</head>
<body>

<h1>Synthèse des participants</h1>
<div class="grid2">
  <table id="tbl-10">
    <thead>
      <tr><th colspan="3">Course 10 km</th></tr>
      <tr><th>Genre</th><th>Catégorie</th><th>Participants</th></tr>
    </thead>
    <tbody><tr><td colspan="3">Chargement…</td></tr></tbody>
  </table>

  <table id="tbl-20">
    <thead>
      <tr><th colspan="3">Course 20 km</th></tr>
      <tr><th>Genre</th><th>Catégorie</th><th>Participants</th></tr>
    </thead>
    <tbody><tr><td colspan="3">Chargement…</td></tr></tbody>
  </table>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain: "calor-run.firebaseapp.com",
  databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calor-run",
  storageBucket: "calor-run.firebasestorage.app",
  messagingSenderId: "329949291334",
  appId: "1:329949291334:web:c71ef20268c609cf953b47",
  measurementId: "G-YVQPW6JGPK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const CATEGORY_ORDER = ["CA","JU","ES","SE","M0","M1","M2","M3","M4","M5","M6","M7","M8","M9","M10"];

function renderTable(course, data, tbody){
  const genres = Object.keys(data).sort();
  const rows = [];
  let totalGeneral = 0;

  genres.forEach(genre=>{
    let subtotal = 0;
    CATEGORY_ORDER.forEach(cat=>{
      const n = data[genre][cat] || 0;
      subtotal += n;
      totalGeneral += n;
      rows.push(`<tr><td>${genre}</td><td>${cat}</td><td>${n}</td></tr>`);
    });
    rows.push(`<tr class="subtotal"><td colspan="2">Sous-total ${genre}</td><td>${subtotal}</td></tr>`);
  });

  rows.push(`<tr class="total"><td colspan="2">Total général</td><td>${totalGeneral}</td></tr>`);
  tbody.innerHTML = rows.join("");
}

function processParticipants(obj){
  const counts = { "10 km": {}, "20 km": {} };

  Object.values(obj||{}).forEach(p=>{
    const course = (p.course||"").includes("20") ? "20 km" : "10 km";
    const genre = (p.genre||"—").trim();
    const cat   = (p.categorie||"—").trim();
    counts[course][genre] = counts[course][genre] || {};
    counts[course][genre][cat] = (counts[course][genre][cat]||0)+1;
  });

  renderTable("10 km", counts["10 km"], document.querySelector("#tbl-10 tbody"));
  renderTable("20 km", counts["20 km"], document.querySelector("#tbl-20 tbody"));
}

db.ref("participants").on("value",snap=>{
  processParticipants(snap.val()||{});
});
</script>
</body>
</html>
