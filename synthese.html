<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Synth√®se Participants (Firebase)</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
<style>
  :root {
    --bg: #f9f9f9;
    --fg: #111;
    --card: #fff;
    --line: #e5e5e5;
    --head-grad: linear-gradient(135deg, #215E99 0%, #E61780 100%);
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: var(--bg); color: var(--fg); line-height: 1.5;
    padding: 24px; overflow-x:hidden;
  }
  h1 { font-size: clamp(1.4rem, 2.5vw, 2rem); margin-bottom: 8px; color:#215E99; }
  p.desc { margin-bottom: 18px; color:#555; }
  .wrap { display: grid; gap: 20px; }
  .card {
    background: var(--card); border:1px solid var(--line); border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.06); padding: 16px;
  }
  .card h2 { font-size: 1.1rem; margin-bottom: 12px; }
  .toolbar { display:flex; gap: 10px; align-items:center; justify-content:space-between; margin-bottom: 8px; }
  .hint { font-size: .9rem; color:#666; }
  .tables { overflow-x: auto; }
  table { width:100%; border-collapse: collapse; min-width: 420px; }
  th, td { border:1px solid var(--line); padding: 8px 10px; text-align: center; font-size: .95rem; }
  th {
    color:#fff; font-weight: 700; position: sticky; top: 0; z-index: 1;
    background: var(--head-grad);
  }
  tbody tr:nth-child(odd){ background:#fff; }
  tbody tr:nth-child(even){ background:#f2f2f2; }
  .muted { color:#777; }
  .badge { display:inline-block; padding:.2em .5em; border-radius: 999px; font-size:.85em; background:#eef1f5; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 900px){ .grid2 { grid-template-columns: 1fr; } }
  .loading, .error { text-align:center; padding: 14px; }
  .error { color: #b00020; font-weight: 600; }
  .subtotal { font-weight: bold; background:#e3f2fd; }
</style>
</head>
<body>

  <h1>Synth√®se des participants</h1>
  <p class="desc">Donn√©es issues de <span class="badge">Firebase / participants</span></p>

  <div class="wrap">

    <!-- R√©partition par course / genre / cat√©gorie -->
    <section class="card">
      <div class="toolbar">
        <h2>R√©partition par genre et cat√©gorie</h2>
        <div class="hint" id="last-update">Derni√®re mise √† jour : <span class="muted">‚Äî</span></div>
      </div>
      <div class="grid2">
        <div class="tables">
          <table id="tbl-10">
            <thead>
              <tr>
                <th colspan="3">Course 10 km</th>
              </tr>
              <tr>
                <th>Genre</th>
                <th>Cat√©gorie</th>
                <th>Participants</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3" class="loading">Chargement‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div class="tables">
          <table id="tbl-20">
            <thead>
              <tr>
                <th colspan="3">Course 20 km</th>
              </tr>
              <tr>
                <th>Genre</th>
                <th>Cat√©gorie</th>
                <th>Participants</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3" class="loading">Chargement‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <div id="err" class="error" style="display:none;"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // --- Config Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.firebasestorage.app",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47",
      measurementId: "G-YVQPW6JGPK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const el = {
      table10: document.querySelector('#tbl-10 tbody'),
      table20: document.querySelector('#tbl-20 tbody'),
      err: document.getElementById('err'),
      lastUpdate: document.querySelector('#last-update span')
    };

    // Ordre fixe des cat√©gories
    const CAT_ORDER = ["CA","JU","ES","SE",
      "M0","M1","M2","M3","M4","M5","M6","M7","M8","M9","M10"];

    function renderTable(course, data, tbody){
      const rows = [];
      const genres = Object.keys(data).sort();

      genres.forEach(genre=>{
        let subtotal = 0;
        CAT_ORDER.forEach(cat=>{
          const n = data[genre][cat] || 0;
          rows.push(`<tr>
            <td>${genre}</td>
            <td>${cat}</td>
            <td>${n}</td>
          </tr>`);
          subtotal += n;
        });
        // Ligne de sous-total apr√®s toutes les cat√©gories de ce genre
        rows.push(`<tr class="subtotal">
          <td colspan="2">Sous-total ${genre}</td>
          <td>${subtotal}</td>
        </tr>`);
      });

      tbody.innerHTML = rows.length ? rows.join('') :
        `<tr><td colspan="3" class="muted">Aucune donn√©e.</td></tr>`;
    }

    function processParticipants(obj){
      const counts = { "10 km": {}, "20 km": {} };

      Object.values(obj||{}).forEach(p=>{
        const course = (p.course === 20) ? "20 km" : "10 km";
        const genre = (p.genre||"‚Äî").toString().trim();
        const cat   = (p.categorie||"‚Äî").toString().trim();

        counts[course][genre] = counts[course][genre] || {};
        counts[course][genre][cat] = (counts[course][genre][cat]||0)+1;
      });

      renderTable("10 km", counts["10 km"], el.table10);
      renderTable("20 km", counts["20 km"], el.table20);

      el.lastUpdate.textContent = new Date().toLocaleTimeString('fr-FR');
    }

    function showError(msg){
      el.err.textContent = msg;
      el.err.style.display = 'block';
    }

    // --- Abonnement Firebase ---
    db.ref('participants').on('value',
      snap=>{
        try {
          const data = snap.val() || {};
          processParticipants(data);
        } catch(e){
          console.error(e);
          showError("Erreur lors du calcul : " + e.message);
        }
      },
      err=>{
        console.error(err);
        showError("Erreur de connexion Firebase : " + err.message);
      }
    );
  </script>
</body>
</html>
