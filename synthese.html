<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Synth√®se Participants (Firebase)</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
<style>
  :root {
    --bg: #f9f9f9;
    --fg: #111;
    --card: #fff;
    --line: #e5e5e5;
    --head-grad: linear-gradient(135deg, #215E99 0%, #E61780 100%);
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: var(--bg); color: var(--fg); line-height: 1.5;
    padding: 24px; overflow-x:hidden;
  }
  h1 { font-size: clamp(1.4rem, 2.5vw, 2rem); margin-bottom: 8px; color:#215E99; }
  p.desc { margin-bottom: 18px; color:#555; }
  .wrap { display: grid; gap: 20px; }
  .card {
    background: var(--card); border:1px solid var(--line); border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.06); padding: 16px;
  }
  .card h2 { font-size: 1.1rem; margin-bottom: 12px; }
  .toolbar { display:flex; gap: 10px; align-items:center; justify-content:space-between; margin-bottom: 8px; }
  .hint { font-size: .9rem; color:#666; }
  .tables { overflow-x: auto; }
  table { width:100%; border-collapse: collapse; min-width: 360px; }
  th, td { border:1px solid var(--line); padding: 8px 10px; text-align: center; font-size: .95rem; }
  th {
    color:#fff; font-weight: 700; position: sticky; top: 0; z-index: 1;
    background: var(--head-grad);
  }
  tbody tr:nth-child(odd){ background:#fff; }
  tbody tr:nth-child(even){ background:#f2f2f2; }
  tfoot td { font-weight: bold; background:#eee; }
  .muted { color:#777; }
  .badge { display:inline-block; padding:.2em .5em; border-radius: 999px; font-size:.85em; background:#eef1f5; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 900px){ .grid2 { grid-template-columns: 1fr; } }
  .loading, .error { text-align:center; padding: 14px; }
  .error { color: #b00020; font-weight: 600; }
</style>
</head>
<body>

  <h1>Synth√®se des participants</h1>
  <p class="desc">Donn√©es issues de <span class="badge">Firebase / participants</span></p>

  <div class="wrap">

    <!-- Tableau 1 : Comptages par Genre x Cat√©gorie, s√©par√©s 10 km et 20 km -->
    <section class="card">
      <div class="toolbar">
        <h2>R√©partition par genre et cat√©gorie</h2>
        <div class="hint" id="last-update">Derni√®re mise √† jour : <span class="muted">‚Äî</span></div>
      </div>
      <div class="grid2">
        <div class="tables">
          <table id="tbl-counts-10">
            <thead>
              <tr><th colspan="3">Course 10 km</th></tr>
              <tr><th>Genre</th><th>Cat√©gorie</th><th>Participants</th></tr>
            </thead>
            <tbody><tr><td colspan="3" class="loading">Chargement‚Ä¶</td></tr></tbody>
            <tfoot></tfoot>
          </table>
        </div>
        <div class="tables">
          <table id="tbl-counts-20">
            <thead>
              <tr><th colspan="3">Course 20 km</th></tr>
              <tr><th>Genre</th><th>Cat√©gorie</th><th>Participants</th></tr>
            </thead>
            <tbody><tr><td colspan="3" class="loading">Chargement‚Ä¶</td></tr></tbody>
            <tfoot></tfoot>
          </table>
        </div>
      </div>
    </section>

    <!-- Tableau 2 : Extr√™mes d‚Äô√¢ge -->
    <section class="card">
      <h2>√Çges extr√™mes par course</h2>
      <div class="grid2">
        <div class="tables">
          <table id="tbl-ages-10">
            <thead>
              <tr><th colspan="4">Course 10 km</th></tr>
              <tr><th>Type</th><th>Nom</th><th>Date de naissance</th><th>√Çge</th></tr>
            </thead>
            <tbody><tr><td colspan="4" class="muted">En attente‚Ä¶</td></tr></tbody>
          </table>
        </div>
        <div class="tables">
          <table id="tbl-ages-20">
            <thead>
              <tr><th colspan="4">Course 20 km</th></tr>
              <tr><th>Type</th><th>Nom</th><th>Date de naissance</th><th>√Çge</th></tr>
            </thead>
            <tbody><tr><td colspan="4" class="muted">En attente‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <div id="err" class="error" style="display:none;"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.firebasestorage.app",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47",
      measurementId: "G-YVQPW6JGPK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const el = {
      counts10Body: document.querySelector('#tbl-counts-10 tbody'),
      counts10Foot: document.querySelector('#tbl-counts-10 tfoot'),
      counts20Body: document.querySelector('#tbl-counts-20 tbody'),
      counts20Foot: document.querySelector('#tbl-counts-20 tfoot'),
      ages10Body: document.querySelector('#tbl-ages-10 tbody'),
      ages20Body: document.querySelector('#tbl-ages-20 tbody'),
      err: document.getElementById('err'),
      lastUpdate: document.querySelector('#last-update span')
    };

    const today = new Date();

    function parseBirthdate(value) {
      if (!value) return null;
      if (typeof value === 'number' && value > 1900) return new Date(value,0,1);
      const raw = String(value).trim();
      if (/^\\d{4}$/.test(raw)) return new Date(parseInt(raw,10),0,1);
      const d = new Date(raw);
      return isNaN(d.getTime()) ? null : d;
    }
    function computeAge(d) {
      if (!d) return null;
      let age = today.getFullYear() - d.getFullYear();
      const m = today.getMonth()-d.getMonth();
      if(m<0||(m===0&&today.getDate()<d.getDate())) age--;
      return age;
    }
    function courseLabel(s) {
      s = String(s||'').toLowerCase();
      if(s.includes('10')) return '10 km';
      if(s.includes('20')) return '20 km';
      return s;
    }

    function renderCounts(course, counts, body, foot) {
      const rows=[]; const subtotals={};
      Object.keys(counts).forEach(genre=>{
        const cats=counts[genre];
        Object.keys(cats).forEach(cat=>{
          const n=cats[cat];
          rows.push(`<tr><td>${genre}</td><td>${cat||'‚Äî'}</td><td>${n}</td></tr>`);
          subtotals[genre]=(subtotals[genre]||0)+n;
        });
      });
      body.innerHTML = rows.length?rows.join(''):`<tr><td colspan="3" class="muted">Aucune donn√©e</td></tr>`;
      const footRows=Object.keys(subtotals).map(g=>`<tr><td colspan="2">Total ${g}</td><td>${subtotals[g]}</td></tr>`);
      foot.innerHTML=footRows.join('');
    }

    function renderAges(body, oldest, youngest){
      const rows=[];
      if(oldest) rows.push(`<tr><td>Plus √¢g√©</td><td>${oldest.nom||''} ${oldest.prenom||''}</td><td>${oldest.naissanceRaw||'‚Äî'}</td><td>${oldest.age}</td></tr>`);
      if(youngest) rows.push(`<tr><td>Plus jeune</td><td>${youngest.nom||''} ${youngest.prenom||''}</td><td>${youngest.naissanceRaw||'‚Äî'}</td><td>${youngest.age}</td></tr>`);
      body.innerHTML=rows.join('')||`<tr><td colspan="4" class="muted">Pas de donn√©es</td></tr>`;
    }

    db.ref('participants').on('value', snap=>{
      const data=snap.val()||{};
      const counts10={}, counts20={};
      const perCourse={'10 km':{oldest:null,youngest:null},'20 km':{oldest:null,youngest:null}};
      Object.values(data).forEach(p=>{
        const course=courseLabel(p.course);
        const genre=p.genre||'‚Äî'; const cat=p.categorie||'‚Äî';
        const target=(course==='10 km')?counts10: (course==='20 km'?counts20:null);
        if(target){
          target[genre]=target[genre]||{}; target[genre][cat]=(target[genre][cat]||0)+1;
          const naissanceRaw=p.dateNaissance||p.naissance||p.dob||p.anneeNaissance;
          const d=parseBirthdate(naissanceRaw); const age=computeAge(d);
          if(age!==null){
            const slot=perCourse[course];
            const pack={nom:p.nom,prenom:p.prenom,naissanceRaw,age};
            if(!slot.oldest||age>slot.oldest.age) slot.oldest=pack;
            if(!slot.youngest||age<slot.youngest.age) slot.youngest=pack;
          }
        }
      });
      renderCounts('10 km', counts10, el.counts10Body, el.counts10Foot);
      renderCounts('20 km', counts20, el.counts20Body, el.counts20Foot);
      renderAges(el.ages10Body, perCourse['10 km'].oldest, perCourse['10 km'].youngest);
      renderAges(el.ages20Body, perCourse['20 km'].oldest, perCourse['20 km'].youngest);
      el.lastUpdate.textContent=new Date().toLocaleTimeString('fr-FR');
    }, err=>{
      el.err.textContent="Erreur Firebase: "+err.message; el.err.style.display='block';
    });
  </script>
</body>
</html>
