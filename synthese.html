<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Synth√®se Participants</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='.9em' font-size='90'>üìä</text></svg>">
<style>
  :root {
    --bg: #f9f9f9;
    --fg: #111;
    --card: #fff;
    --line: #e5e5e5;
    --head-grad: linear-gradient(135deg, #215E99 0%, #E61780 100%);
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg);padding:24px;}
  h1{font-size:2rem;margin-bottom:12px;color:#215E99;}
  .wrap{display:grid;gap:20px;}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px;}
  .card h2{font-size:1.2rem;margin-bottom:12px;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  @media (max-width:900px){.grid2{grid-template-columns:1fr;}}
  table{width:100%;border-collapse:collapse;}
  th,td{border:1px solid var(--line);padding:8px 10px;text-align:center;font-size:.95rem;}
  th{color:#fff;font-weight:700;position:sticky;top:0;z-index:1;background:var(--head-grad);}
  tbody tr:nth-child(odd){background:#fff;}
  tbody tr:nth-child(even){background:#f2f2f2;}
  tbody tr:hover{background:#e0f0ff;transition:0.2s;}
  tfoot tr{font-weight:700;}
  tfoot tr.pulse{animation:pulseTotal 1.2s infinite;background:#fffae6;}
  @keyframes pulseTotal{0%,100%{background:#fffae6;}50%{background:#fff1b8;}}
  .muted{color:#777;}
  .loading,.error{text-align:center;padding:14px;}
  .error{color:#b00020;font-weight:600;}
</style>
</head>
<body>

<h1>Synth√®se des participants</h1>

<div class="wrap">

  <!-- Carte 1 : Cat√©gories -->
  <section class="card">
    <h2>R√©partition par cat√©gories</h2>
    <div class="grid2">
      <div>
        <h3>10 km</h3>
        <table id="cat10">
          <thead>
            <tr><th>Cat√©gorie</th><th>Nombre F</th><th>Nombre H</th><th>Total</th></tr>
          </thead>
          <tbody><tr><td colspan="4" class="muted">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </div>
      <div>
        <h3>20 km</h3>
        <table id="cat20">
          <thead>
            <tr><th>Cat√©gorie</th><th>Nombre F</th><th>Nombre H</th><th>Total</th></tr>
          </thead>
          <tbody><tr><td colspan="4" class="muted">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Carte 2 : √Çges extr√™mes -->
  <section class="card">
    <h2>√Çges extr√™mes</h2>
    <div class="grid2">
      <div>
        <h3>10 km</h3>
        <table id="ages10">
          <thead><tr><th>Dossard</th><th>Pr√©nom</th><th>Nom</th><th>√Çge</th></tr></thead>
          <tbody><tr><td colspan="4" class="muted">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </div>
      <div>
        <h3>20 km</h3>
        <table id="ages20">
          <thead><tr><th>Dossard</th><th>Pr√©nom</th><th>Nom</th><th>√Çge</th></tr></thead>
          <tbody><tr><td colspan="4" class="muted">Chargement‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <div id="err" class="error" style="display:none;"></div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain: "calor-run.firebaseapp.com",
  databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calor-run",
  storageBucket: "calor-run.firebasestorage.app",
  messagingSenderId: "329949291334",
  appId: "1:329949291334:web:c71ef20268c609cf953b47",
  measurementId: "G-YVQPW6JGPK"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const el = {
  cat10: document.querySelector('#cat10 tbody'),
  cat20: document.querySelector('#cat20 tbody'),
  ages10: document.querySelector('#ages10 tbody'),
  ages20: document.querySelector('#ages20 tbody'),
  err: document.getElementById('err')
};

const catOrder=['CA','JU','ES','SE','M0','M1','M2','M3','M4','M5','M6','M7','M8','M9','M10'];

function parseBirthdate(value){
  if(!value) return null;
  const y=parseInt(value,10);
  if(y>1900 && y<=new Date().getFullYear()) return new Date(y,0,1);
  return null;
}
function computeAge(birthDate){
  if(!birthDate) return null;
  let age=new Date().getFullYear()-birthDate.getFullYear();
  if(new Date()<new Date(new Date().getFullYear(),birthDate.getMonth(),birthDate.getDate())) age--;
  return age;
}
function renderCatTable(tableBody, counts){
  let rows=[],totalF=0,totalH=0;
  catOrder.forEach(cat=>{
    const nF=counts[cat]?.F||0,nH=counts[cat]?.H||0,total=nF+nH;
    totalF+=nF; totalH+=nH;
    rows.push(`<tr><td>${cat}</td><td>${nF}</td><td>${nH}</td><td>${total}</td></tr>`);
  });
  const grandTotal=totalF+totalH;
  const percF=grandTotal?Math.round(totalF*100/grandTotal):0;
  const percH=grandTotal?Math.round(totalH*100/grandTotal):0;
  tableBody.innerHTML=rows.join('')+`<tfoot><tr class="pulse"><td>Totaux</td><td>${totalF} (${percF}%)</td><td>${totalH} (${percH}%)</td><td>${grandTotal}</td></tr></tfoot>`;
}
function renderAges(tableBody, oldest, youngest){
  const rows=[];
  if(oldest) rows.push(`<tr><td>${oldest.dossard}</td><td>${oldest.prenom}</td><td>${oldest.nom}</td><td>${oldest.age}</td></tr>`);
  if(youngest) rows.push(`<tr><td>${youngest.dossard}</td><td>${youngest.prenom}</td><td>${youngest.nom}</td><td>${youngest.age}</td></tr>`);
  tableBody.innerHTML=rows.length?rows.join(''):`<tr><td colspan="4" class="muted">Aucune donn√©e.</td></tr>`;
}

db.ref('participants').on('value',snap=>{
  try{
    const data=snap.val()||{};
    const counts10={},counts20={};
    let oldest10=null,youngest10=null,oldest20=null,youngest20=null;
    Object.keys(data).forEach(dossard=>{
      const p=data[dossard]||{};
      const course=parseInt(p.course,10);
      const cat=p.categorie||'‚Äî';
      const genre=p.genre||'';
      // Cat√©gories
      const targetCounts=course===10?counts10:counts20;
      targetCounts[cat]=targetCounts[cat]||{F:0,H:0};
      if(genre.toLowerCase()==='f' || genre.toLowerCase()==='femme') targetCounts[cat].F++;
      else targetCounts[cat].H++;
      // √Çges extr√™mes
      const birth=parseBirthdate(p.date_naiss);
      const age=computeAge(birth);
      const pack={dossard,nom:p.nom||'',prenom:p.prenom||'',age};
      if(course===10 && age!=null){
        if(!oldest10 || age>oldest10.age) oldest10=pack;
        if(!youngest10 || age<youngest10.age) youngest10=pack;
      }
      if(course===20 && age!=null){
        if(!oldest20 || age>oldest20.age) oldest20=pack;
        if(!youngest20 || age<youngest20.age) youngest20=pack;
      }
    });
    renderCatTable(el.cat10,counts10);
    renderCatTable(el.cat20,counts20);
    renderAges(el.ages10,oldest10,youngest10);
    renderAges(el.ages20,oldest20,youngest20);
  }catch(e){el.err.textContent="Erreur: "+e.message;el.err.style.display='block';console.error(e);}
});
</script>
</body>
</html>
