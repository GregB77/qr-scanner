<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stats Calor Run</title>
<style>
:root {
  --bg:#f9f9f9; --fg:#111; --card:#fff; --line:#e5e5e5; --head-grad:linear-gradient(135deg,#215E99 0%,#E61780 100%);
}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg);line-height:1.5;padding:24px;}
h1{font-size:2rem;margin-bottom:8px;color:#215E99;}
.wrap{display:grid;gap:20px;}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px;}
.card h2{font-size:1.1rem;margin-bottom:12px;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
@media(max-width:900px){.grid2{grid-template-columns:1fr;}}
.tables{overflow-x:auto;}
table{width:100%;border-collapse:collapse;min-width:320px;}
th,td{border:1px solid var(--line);padding:6px 8px;text-align:center;font-size:.95rem;}
th{color:#fff;font-weight:700;background:var(--head-grad);}
tbody tr:nth-child(odd){background:#fff;}
tbody tr:nth-child(even){background:#f2f2f2;}
.muted{color:#777;}
.pulse{animation:pulse 1s infinite;}
@keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);}}
.loading,.error{text-align:center;padding:14px;}
.error{color:#b00020;font-weight:600;}
</style>
</head>
<body>

<div class="wrap">

<section class="card">
<h2>Répartition par catégories</h2>
<div class="grid2">
  <div class="tables">
    <table id="tbl-cat-10">
      <thead>
        <tr><th>Catégorie</th><th>Nombre F</th><th>Nombre H</th><th>Total</th></tr>
      </thead>
      <tbody><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
    </table>
  </div>
  <div class="tables">
    <table id="tbl-cat-20">
      <thead>
        <tr><th>Catégorie</th><th>Nombre F</th><th>Nombre H</th><th>Total</th></tr>
      </thead>
      <tbody><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
    </table>
  </div>
</div>
</section>

<section class="card">
<h2>Âges extrêmes</h2>
<div class="grid2">
  <div class="tables">
    <table id="tbl-age-10">
      <thead><tr><th>Dossard</th><th>Prénom</th><th>Nom</th><th>Âge</th></tr></thead>
      <tbody><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
    </table>
  </div>
  <div class="tables">
    <table id="tbl-age-20">
      <thead><tr><th>Dossard</th><th>Prénom</th><th>Nom</th><th>Âge</th></tr></thead>
      <tbody><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
    </table>
  </div>
</div>
</section>

<div id="err" class="error" style="display:none;"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain:"calor-run.firebaseapp.com",
  databaseURL:"https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"calor-run",
  storageBucket:"calor-run.firebasestorage.app",
  messagingSenderId:"329949291334",
  appId:"1:329949291334:web:c71ef20268c609cf953b47"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const el = {
  cat10: document.querySelector('#tbl-cat-10 tbody'),
  cat20: document.querySelector('#tbl-cat-20 tbody'),
  age10: document.querySelector('#tbl-age-10 tbody'),
  age20: document.querySelector('#tbl-age-20 tbody'),
  err: document.getElementById('err')
};

const orderCat = ['CA','JU','ES','SE','M0','M1','M2','M3','M4','M5','M6','M7','M8','M9','M10'];

function parseDate(d){if(!d)return null;const dt=new Date(d);return isNaN(dt.getTime())?null:dt;}
function computeAge(d){if(!d)return null;const today=new Date();let a=today.getFullYear()-d.getFullYear();if(today.getMonth()<d.getMonth()||(today.getMonth()===d.getMonth()&&today.getDate()<d.getDate()))a--;return a;}

function renderCats(body10, body20, data){
  const counts = {10:{},20:{}};
  Object.values(data||{}).forEach(p=>{
    const course = Number(p.course)||0;
    const cat = p.categorie||'—';
    const genre = (p.genre||'').toLowerCase();
    counts[course] = counts[course]||{};
    counts[course][cat] = counts[course][cat]||{f:0,h:0};
    if(genre==='f' || genre==='femme') counts[course][cat].f++;
    else counts[course][cat].h++;
  });

  function buildRows(countObj){
    const rows=[];
    let totF=0,totH=0;
    orderCat.forEach(cat=>{
      const val = countObj[cat]||{f:0,h:0};
      const total = val.f+val.h;
      rows.push(`<tr><td>${cat}</td><td>${val.f}</td><td>${val.h}</td><td>${total}</td></tr>`);
      totF+=val.f; totH+=val.h;
    });
    const totalT = totF+totH;
    rows.push(`<tr style="font-weight:700"><td>Totaux</td><td>${totF} (${Math.round(100*totF/totalT)}%)</td><td>${totH} (${Math.round(100*totH/totalT)}%)</td><td>${totalT}</td></tr>`);
    return rows.join('');
  }
  body10.innerHTML = buildRows(counts[10]||{});
  body20.innerHTML = buildRows(counts[20]||{});
}

function renderAges(body10, body20, data){
  const ages={10:{oldest:null,youngest:null},20:{oldest:null,youngest:null}};
  Object.values(data||{}).forEach(p=>{
    const course = Number(p.course)||0;
    const birth = parseDate(p.date_naiss);
    const age = computeAge(birth);
    if(!birth||age===null) return;
    const pack={dossard:p.dossard||'',prenom:p.prenom||'',nom:p.nom||'',age};
    if(course===10){
      if(!ages[10].oldest||age>ages[10].oldest.age) ages[10].oldest=pack;
      if(!ages[10].youngest||age<ages[10].youngest.age) ages[10].youngest=pack;
    }
    if(course===20){
      if(!ages[20].oldest||age>ages[20].oldest.age) ages[20].oldest=pack;
      if(!ages[20].youngest||age<ages[20].youngest.age) ages[20].youngest=pack;
    }
  });

  function buildRows(a){return [a.oldest,a.youngest].filter(Boolean).map(p=>`<tr><td>${p.dossard}</td><td>${p.prenom}</td><td>${p.nom}</td><td>${p.age}</td></tr>`).join('')||'<tr><td colspan="4" class="muted">Aucune donnée.</td></tr>'; }
  body10.innerHTML=buildRows(ages[10]);
  body20.innerHTML=buildRows(ages[20]);
}

function showError(msg){el.err.style.display='block';el.err.textContent=msg;}

db.ref('participants').on('value',snap=>{
  try{
    const data = snap.val()||{};
    renderCats(el.cat10,el.cat20,data);
    renderAges(el.age10,el.age20,data);
  }catch(e){
    console.error(e);
    showError("Erreur traitement : "+e.message);
  }
},err=>{console.error(err);showError("Erreur Firebase : "+err.message);});
</script>
</body>
</html>
