<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Synth√®se Participants (Firebase)</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
<style>
  :root {
    --bg: #f9f9f9;
    --fg: #111;
    --card: #fff;
    --line: #e5e5e5;
    --head-grad: linear-gradient(135deg, #215E99 0%, #E61780 100%);
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: var(--bg); color: var(--fg); line-height: 1.5;
    padding: 24px; overflow-x:hidden;
  }
  h1 { font-size: clamp(1.4rem, 2.5vw, 2rem); margin-bottom: 8px; color:#215E99; }
  p.desc { margin-bottom: 18px; color:#555; }
  .wrap { display: grid; gap: 20px; }
  .card {
    background: var(--card); border:1px solid var(--line); border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.06); padding: 16px;
  }
  .card h2 { font-size: 1.1rem; margin-bottom: 12px; }
  .tables { overflow-x: auto; }
  table { width:100%; border-collapse: collapse; min-width: 360px; border-radius: 12px; overflow: hidden; }
  th, td { border:1px solid var(--line); padding: 8px 10px; text-align: center; font-size: .95rem; }
  th {
    color:#fff; font-weight: 700; position: sticky; top: 0; z-index: 1;
    background: var(--head-grad);
  }
  tbody tr:nth-child(odd){ background:#fff; }
  tbody tr:nth-child(even){ background:#f2f2f2; }
  tfoot tr { font-weight: bold; background:#e0e0e0; }
  .muted { color:#777; }
  .badge { display:inline-block; padding:.2em .5em; border-radius: 999px; font-size:.85em; background:#eef1f5; }
  .loading, .error { text-align:center; padding: 14px; }
  .error { color: #b00020; font-weight: 600; }
</style>
</head>
<body>

<h1>Synth√®se des participants</h1>
<p class="desc">Donn√©es issues de <span class="badge">Firebase / participants</span></p>

<div class="wrap">

  <section class="card">
    <h2>R√©partition par cat√©gorie</h2>
    <div class="tables">
      <table id="tbl-counts">
        <thead>
          <tr>
            <th>Cat√©gorie</th>
            <th>Nombre F</th>
            <th>Nombre H</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="4" class="loading">Chargement‚Ä¶</td></tr>
        </tbody>
        <tfoot>
          <tr><td colspan="4" class="muted">Totaux calcul√©s apr√®s chargement</td></tr>
        </tfoot>
      </table>
    </div>
  </section>

  <div id="err" class="error" style="display:none;"></div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain: "calor-run.firebaseapp.com",
  databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calor-run",
  storageBucket: "calor-run.firebasestorage.app",
  messagingSenderId: "329949291334",
  appId: "1:329949291334:web:c71ef20268c609cf953b47",
  measurementId: "G-YVQPW6JGPK"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const CAT_ORDER = ["CA","JU","ES","SE","M0","M1","M2","M3","M4","M5","M6","M7","M8","M9","M10"];

const el = {
  countsBody: document.querySelector('#tbl-counts tbody'),
  countsFoot: document.querySelector('#tbl-counts tfoot'),
  err: document.getElementById('err')
};

function renderTable(data){
  const rows = [];
  let totF = 0, totH = 0, totAll = 0;

  CAT_ORDER.forEach(cat => {
    const femmes = data[cat]?.F || 0;
    const hommes = data[cat]?.H || 0;
    const total = femmes + hommes;

    totF += femmes; totH += hommes; totAll += total;

    rows.push(`<tr>
      <td>${cat}</td>
      <td>${femmes}</td>
      <td>${hommes}</td>
      <td>${total}</td>
    </tr>`);
  });

  el.countsBody.innerHTML = rows.join('');

  // Calcul pourcentage
  const pctF = totAll ? Math.round((totF / totAll) * 100) : 0;
  const pctH = totAll ? Math.round((totH / totAll) * 100) : 0;

  el.countsFoot.innerHTML = `<tr>
    <td>Totaux</td>
    <td>${totF} (${pctF}%)</td>
    <td>${totH} (${pctH}%)</td>
    <td>${totAll}</td>
  </tr>`;
}

// Lecture des participants
db.ref('participants').on('value',
  snap => {
    try {
      const data = snap.val() || {};
      const summary = {};

      Object.values(data).forEach(p => {
        const cat = (p.categorie || '').toString().trim();
        const genre = (p.genre || '').toString().trim().toUpperCase();
        if (!CAT_ORDER.includes(cat)) return;

        summary[cat] = summary[cat] || {};
        if (genre === 'F' || genre === 'FEMME') summary[cat].F = (summary[cat].F||0)+1;
        else summary[cat].H = (summary[cat].H||0)+1;
      });

      renderTable(summary);
    } catch(e){
      console.error(e);
      el.err.style.display='block';
      el.err.textContent="Erreur : "+e.message;
    }
  },
  err => {
    console.error(err);
    el.err.style.display='block';
    el.err.textContent="Erreur de connexion Firebase : "+err.message;
  }
);
</script>
</body>
</html>
