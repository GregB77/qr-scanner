<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statistiques Calor Run</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
<style>
  :root {
    --bg: #f9f9f9;
    --fg: #111;
    --card: #fff;
    --line: #e5e5e5;
    --head-grad: linear-gradient(135deg, #215E99 0%, #E61780 100%);
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: var(--bg); color: var(--fg); line-height: 1.5;
    padding: 24px; overflow-x:hidden;
  }
  h1 { font-size: clamp(1.4rem, 2.5vw, 2rem); margin-bottom: 8px; color:#215E99; }
  p.desc { margin-bottom: 18px; color:#555; }
  .wrap { display: grid; gap: 20px; }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 900px){ .grid2 { grid-template-columns: 1fr; } }
  .card {
    background: var(--card); border:1px solid var(--line); border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.06); padding: 16px;
  }
  .card h2 { font-size: 1.1rem; margin-bottom: 12px; }
  .tables { overflow-x: auto; }
  table { width:100%; border-collapse: collapse; min-width: 320px; border-radius: 12px; overflow: hidden; margin-bottom: 8px; }
  th, td { border:1px solid var(--line); padding: 8px 10px; text-align: center; font-size: .95rem; }
  th {
    color:#fff; font-weight: 700; position: sticky; top: 0; z-index: 1;
    background: var(--head-grad);
  }
  tbody tr:nth-child(odd){ background:#fff; }
  tbody tr:nth-child(even){ background:#f2f2f2; }
  tfoot tr { font-weight: bold; background:#e0e0e0; }
  .muted { color:#777; }
  .badge { display:inline-block; padding:.2em .5em; border-radius: 999px; font-size:.85em; background:#eef1f5; }
  .loading, .error { text-align:center; padding: 14px; }
  .error { color: #b00020; font-weight: 600; }
</style>
</head>
<body>

<!-- <h1>Synth√®se des participants</h1>
<p class="desc">Donn√©es issues de <span class="badge">Firebase / participants</span></p> -->

<div class="wrap">

  <!-- Tableau synth√®se 10km / 20km -->
  <section class="card">
    <h2>R√©partition par cat√©gorie (10 km et 20 km)</h2>
    <div class="grid2">
      <div class="tables">
        <table id="tbl-10">
          <thead>
            <tr>
              <th>Cat√©gorie</th>
              <th>Nombre F</th>
              <th>Nombre H</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="loading">Chargement‚Ä¶</td></tr>
          </tbody>
          <tfoot>
            <tr><td colspan="4" class="muted">Totaux calcul√©s apr√®s chargement</td></tr>
          </tfoot>
        </table>
      </div>
      <div class="tables">
        <table id="tbl-20">
          <thead>
            <tr>
              <th>Cat√©gorie</th>
              <th>Nombre F</th>
              <th>Nombre H</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="loading">Chargement‚Ä¶</td></tr>
          </tbody>
          <tfoot>
            <tr><td colspan="4" class="muted">Totaux calcul√©s apr√®s chargement</td></tr>
          </tfoot>
        </table>
      </div>
    </div>
  </section>

  <!-- Tableau √¢ges extr√™mes -->
  <section class="card">
    <h2>Participants les plus √¢g√©s et les plus jeunes</h2>
    <div class="grid2">
      <div class="tables">
        <table id="ages-10">
          <thead>
            <tr>
              <th colspan="4">Course 10 km</th>
            </tr>
            <tr>
              <th>Dossard</th>
              <th>Pr√©nom</th>
              <th>Nom</th>
              <th>√Çge</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="muted">En attente de donn√©es‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
      <div class="tables">
        <table id="ages-20">
          <thead>
            <tr>
              <th colspan="4">Course 20 km</th>
            </tr>
            <tr>
              <th>Dossard</th>
              <th>Pr√©nom</th>
              <th>Nom</th>
              <th>√Çge</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="muted">En attente de donn√©es‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <div id="err" class="error" style="display:none;"></div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain: "calor-run.firebaseapp.com",
  databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calor-run",
  storageBucket: "calor-run.firebasestorage.app",
  messagingSenderId: "329949291334",
  appId: "1:329949291334:web:c71ef20268c609cf953b47",
  measurementId: "G-YVQPW6JGPK"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const CAT_ORDER = ["CA","JU","ES","SE","M0","M1","M2","M3","M4","M5","M6","M7","M8","M9","M10"];

const el = {
  tbl10: { body: document.querySelector('#tbl-10 tbody'), foot: document.querySelector('#tbl-10 tfoot') },
  tbl20: { body: document.querySelector('#tbl-20 tbody'), foot: document.querySelector('#tbl-20 tfoot') },
  ages10: document.querySelector('#ages-10 tbody'),
  ages20: document.querySelector('#ages-20 tbody'),
  err: document.getElementById('err')
};

function renderTable(tableEl, data){
  const rows = [];
  let totF = 0, totH = 0, totAll = 0;

  CAT_ORDER.forEach(cat => {
    const femmes = data[cat]?.F || 0;
    const hommes = data[cat]?.H || 0;
    const total = femmes + hommes;

    totF += femmes; totH += hommes; totAll += total;

    rows.push(`<tr>
      <td>${cat}</td>
      <td>${femmes}</td>
      <td>${hommes}</td>
      <td>${total}</td>
    </tr>`);
  });

  tableEl.body.innerHTML = rows.join('');

  const pctF = totAll ? Math.round((totF / totAll) * 100) : 0;
  const pctH = totAll ? Math.round((totH / totAll) * 100) : 0;

  tableEl.foot.innerHTML = `<tr>
    <td>Totaux</td>
    <td>${totF} (${pctF}%)</td>
    <td>${totH} (${pctH}%)</td>
    <td>${totAll}</td>
  </tr>`;
}

function parseBirthdate(value){
  if (!value) return null;
  const y = Number(value);
  if (!isNaN(y) && y > 1900 && y <= new Date().getFullYear()) return new Date(y,0,1);
  return new Date(value);
}

function computeAge(d){ 
  if(!d || isNaN(d)) return null;
  let age = new Date().getFullYear() - d.getFullYear();
  const m = new Date().getMonth() - d.getMonth();
  if(m<0 || (m===0 && new Date().getDate() < d.getDate())) age--;
  return age;
}

function renderAges(tableBody, oldest, youngest){
  const rows = [];
  if(oldest) rows.push(`<tr>
    <td>${oldest.dossard}</td>
    <td>${oldest.prenom}</td>
    <td>${oldest.nom}</td>
    <td>${oldest.age}</td>
  </tr>`);
  if(youngest) rows.push(`<tr>
    <td>${youngest.dossard}</td>
    <td>${youngest.prenom}</td>
    <td>${youngest.nom}</td>
    <td>${youngest.age}</td>
  </tr>`);
  tableBody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="4" class="muted">Aucune donn√©e utile</td></tr>`;
}

db.ref('participants').on('value', snap=>{
  try{
    const data = snap.val() || {};
    const summary10 = {}, summary20 = {};
    let ages10 = {oldest:null, youngest:null}, ages20={oldest:null, youngest:null};

    Object.values(data).forEach(p=>{
      const cat = (p.categorie||'').toString().trim();
      const genre = (p.genre||'').toString().trim().toUpperCase();
      const course = Number(p.course);

      // Tableau cat√©gories
      if(CAT_ORDER.includes(cat)){
        const target = course===10 ? summary10 : course===20 ? summary20 : null;
        if(target){
          target[cat] = target[cat]||{};
          if(genre==='F' || genre==='FEMME') target[cat].F = (target[cat].F||0)+1;
          else target[cat].H = (target[cat].H||0)+1;
        }
      }

      // Tableau √¢ges
      const birth = parseBirthdate(p.dateNaissance||p.naissance||p.dob||p.birthdate||p.anneeNaissance||p.birthYear);
      const age = computeAge(birth);
      if(age!==null && (course===10 || course===20)){
        const pack = {dossard:p.dossard||'', nom:p.nom||'', prenom:p.prenom||'', age};
        const slot = course===10 ? ages10 : ages20;
        if(!slot.oldest || age>slot.oldest.age) slot.oldest=pack;
        if(!slot.youngest || age<slot.youngest.age) slot.youngest=pack;
      }
    });

    renderTable(el.tbl10, summary10);
    renderTable(el.tbl20, summary20);
    renderAges(el.ages10, ages10.oldest, ages10.youngest);
    renderAges(el.ages20, ages20.oldest, ages20.youngest);

  }catch(e){
    console.error(e);
    el.err.style.display='block';
    el.err.textContent="Erreur : "+e.message;
  }
}, err=>{
  console.error(err);
  el.err.style.display='block';
  el.err.textContent="Erreur de connexion Firebase : "+err.message;
});
</script>

</body>
</html>
