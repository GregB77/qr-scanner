<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stats Calor Run</title>
<style>
:root {
  --bg:#f9f9f9; --fg:#111; --card:#fff; --line:#e5e5e5; --head-grad:linear-gradient(135deg,#215E99 0%,#E61780 100%);
}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--fg);line-height:1.5;padding:24px;}
body.dark{--bg:#111; --fg:#f9f9f9; --card:#222; --line:#555;}
h1{font-size:2rem;margin-bottom:8px;color:#215E99;}
.wrap{display:grid;gap:20px;}
.card{background:var(--card);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px;}
.card h2{font-size:1.1rem;margin-bottom:12px;}
.tables{overflow-x:auto;}
table{width:100%;border-collapse:collapse;min-width:640px;}
th,td{border:1px solid var(--line);padding:6px 8px;text-align:center;font-size:.95rem;}
th{color:#fff;font-weight:700;background:var(--head-grad);}
tbody tr:nth-child(odd){background:#fff;}
body.dark tbody tr:nth-child(odd){background:#222;}
tbody tr:nth-child(even){background:#f2f2f2;}
body.dark tbody tr:nth-child(even){background:#333;}
.muted{color:#777;}
th.sep, td.sep { border-left:1px solid #ccc; }
th.total, td.total { font-weight:700; }
.last-update{margin-top:12px;font-size:0.9rem;color:#555;}
body.dark .last-update{color:#ccc;}
</style>
</head>
<body>

<div class="wrap">

<section class="card">
<h2>Répartition par catégories</h2>
<div class="tables">
  <table id="tbl-cat">
    <thead>
      <tr>
        <th>Catégorie</th>
        <th class="sep">Femmes (10km)</th>
        <th>Hommes (10km)</th>
        <th class="total">Total (10km)</th>
        <th class="sep">Femmes (20km)</th>
        <th>Hommes (20km)</th>
        <th class="total">Total (20km)</th>
        <th class="sep total">Total général</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="8" class="muted">Chargement…</td></tr></tbody>
    <tfoot><tr><td colspan="8" id="last-update-cat" class="muted">Dernière mise à jour : --:--:--</td></tr></tfoot>
  </table>
</div>
</section>

<section class="card">
<h2>Âges extrêmes — 10 km | 20 km</h2>
<div class="tables" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
  
  <table id="tbl-age-10">
    <thead>
      <tr><th>Dossard</th><th>Prénom</th><th>Nom</th><th>Âge</th></tr>
    </thead>
    <tbody><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
    <tfoot><tr><td colspan="4" id="last-update-age10" class="muted">Dernière mise à jour : --:--:--</td></tr></tfoot>
  </table>

  <table id="tbl-age-20">
    <thead>
      <tr><th>Dossard</th><th>Prénom</th><th>Nom</th><th>Âge</th></tr>
    </thead>
    <tbody><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
    <tfoot><tr><td colspan="4" id="last-update-age20" class="muted">Dernière mise à jour : --:--:--</td></tr></tfoot>
  </table>

</div>
</section>

<div id="err" class="error" style="display:none;"></div>
<p class="last-update">
  <a href="#" id="theme-toggle">Basculer le thème</a>
</p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain:"calor-run.firebaseapp.com",
  databaseURL:"https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"calor-run",
  storageBucket:"calor-run.firebasestorage.app",
  messagingSenderId:"329949291334",
  appId:"1:329949291334:web:c71ef20268c609cf953b47"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const el = {
  cat: document.querySelector('#tbl-cat tbody'),
  age10: document.querySelector('#tbl-age-10 tbody'),
  age20: document.querySelector('#tbl-age-20 tbody'),
  err: document.getElementById('err')
};

const updateEl = {
  cat: document.getElementById('last-update-cat'),
  age10: document.getElementById('last-update-age10'),
  age20: document.getElementById('last-update-age20')
};

const orderCat = ['CA','JU','ES','SE','M0','M1','M2','M3','M4','M5','M6','M7','M8','M9','M10'];

function parseDate(d){if(!d)return null;const dt=new Date(d);return isNaN(dt.getTime())?null:dt;}
function computeAge(d){if(!d)return null;const today=new Date();let a=today.getFullYear()-d.getFullYear();if(today.getMonth()<d.getMonth()||(today.getMonth()===d.getMonth()&&today.getDate()<d.getDate()))a--;return a;}

function formatTime(dt){return dt.toLocaleTimeString();}

function renderCats(body, data){
  const counts = {10:{},20:{}};
  Object.values(data||{}).forEach(p=>{
    const course = Number(p.course)||0;
    const cat = p.categorie||'—';
    const genre = (p.genre||'').toLowerCase();
    counts[course][cat] = counts[course][cat]||{f:0,h:0};
    if(genre==='f' || genre==='femme') counts[course][cat].f++;
    else counts[course][cat].h++;
  });

  const rows=[];
  let tot10f=0,tot10h=0,tot20f=0,tot20h=0;
  orderCat.forEach(cat=>{
    const v10 = counts[10][cat]||{f:0,h:0};
    const v20 = counts[20][cat]||{f:0,h:0};
    const t10 = v10.f+v10.h;
    const t20 = v20.f+v20.h;
    const total = t10+t20;
    rows.push(`<tr>
      <td>${cat}</td>
      <td class="sep">${v10.f}</td><td>${v10.h}</td><td class="total">${t10}</td>
      <td class="sep">${v20.f}</td><td>${v20.h}</td><td class="total">${t20}</td>
      <td class="sep total">${total}</td>
    </tr>`);
    tot10f+=v10.f; tot10h+=v10.h;
    tot20f+=v20.f; tot20h+=v20.h;
  });

  const tot10 = tot10f+tot10h;
  const tot20 = tot20f+tot20h;
  const grandTotal = tot10+tot20;

  rows.push(`<tr style="font-weight:700">
    <td>Totaux</td>
    <td class="sep">${tot10f} (${Math.round(100*tot10f/tot10||0)}%)</td>
    <td>${tot10h} (${Math.round(100*tot10h/tot10||0)}%)</td>
    <td class="total">${tot10}</td>
    <td class="sep">${tot20f} (${Math.round(100*tot20f/tot20||0)}%)</td>
    <td>${tot20h} (${Math.round(100*tot20h/tot20||0)}%)</td>
    <td class="total">${tot20}</td>
    <td class="sep total">${grandTotal}</td>
  </tr>`);

  body.innerHTML = rows.join('');
  updateEl.cat.textContent = "Dernière mise à jour : " + formatTime(new Date());
}

function renderAges(body10, body20, data){
  const ages={10:{oldest:null,youngest:null},20:{oldest:null,youngest:null}};
  Object.values(data||{}).forEach(p=>{
    const course = Number(p.course)||0;
    const birth = parseDate(p.date_naiss);
    const age = computeAge(birth);
    if(!birth||age===null) return;
    const pack={dossard:p.dossard||'',prenom:p.prenom||'',nom:p.nom||'',age};
    if(course===10){
      if(!ages[10].oldest||age>ages[10].oldest.age) ages[10].oldest=pack;
      if(!ages[10].youngest||age<ages[10].youngest.age) ages[10].youngest=pack;
    }
    if(course===20){
      if(!ages[20].oldest||age>ages[20].oldest.age) ages[20].oldest=pack;
      if(!ages[20].youngest||age<ages[20].youngest.age) ages[20].youngest=pack;
    }
  });

  function buildRows(a){return [a.oldest,a.youngest].filter(Boolean).map(p=>`<tr>
    <td>${p.dossard}</td><td>${p.prenom}</td><td>${p.nom}</td><td>${p.age} ans</td>
  </tr>`).join('')||'<tr><td colspan="4" class="muted">Aucune donnée.</td></tr>';}

  body10.innerHTML=buildRows(ages[10]);
  body20.innerHTML=buildRows(ages[20]);

  updateEl.age10.textContent = "Dernière mise à jour : " + formatTime(new Date());
  updateEl.age20.textContent = "Dernière mise à jour : " + formatTime(new Date());
}

function showError(msg){el.err.style.display='block';el.err.textContent=msg;}

// Theme toggle
document.getElementById('theme-toggle').addEventListener('click', e=>{
  e.preventDefault();
  document.body.classList.toggle('dark');
});

db.ref('participants').on('value',snap=>{
  try{
    const data = snap.val()||{};
    renderCats(el.cat,data);
    renderAges(el.age10,el.age20,data);
  }catch(e){
    console.error(e);
    showError("Erreur traitement : "+e.message);
  }
},err=>{console.error(err);showError("Erreur Firebase : "+err.message);});
</script>
</body>
</html>
