<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Classement Live Triable</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { cursor: pointer; background: #f0f0f0; user-select: none; }
  tr:nth-child(even) { background: #fafafa; }
  th.asc::after { content: " ↑"; }
  th.desc::after { content: " ↓"; }
</style>
</head>
<body>

<h1>Classement Live Triable</h1>
<table id="classement">
  <thead>
    <tr>
      <th>Dossard</th>
      <th>Nom</th>
      <th>Prénom</th>
      <th>Temps</th>
      <th>Course</th>
      <th>Scratch</th>
      <th>Genre</th>
      <th>Pos. Genre</th>
      <th>CAT</th>
      <th>Pos. CAT</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
    authDomain: "calor-run.firebaseapp.com",
    databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "calor-run",
    storageBucket: "calor-run.firebasestorage.app",
    messagingSenderId: "329949291334",
    appId: "1:329949291334:web:c71ef20268c609cf953b47"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let scanData = [];
  let sortConfig = { key: "timeMs", direction: "asc" };

  async function fetchData() {
    const [departSnap, partSnap, scanSnap] = await Promise.all([
      db.ref('depart_courses').once('value'),
      db.ref('participants').once('value'),
      db.ref('scans_dossards').once('value')
    ]);

    const departCourses = departSnap.val() || {};
    const participants = partSnap.val() || {};
    const scans = scanSnap.val() || {};

    scanData = Object.entries(scans).map(([dossard, data]) => {
      const participant = participants[dossard] || {};
      const departISO = departCourses[participant.course] || null;
      const scanDate = new Date(data.dateTime);
      let timeStr = "--:--:--";
      let timeMs = 0;
      if (departISO) {
        const departDate = new Date(departISO);
        timeMs = scanDate - departDate;
        if (!isNaN(timeMs) && timeMs >= 0) {
          const h = String(Math.floor(timeMs/3600000)).padStart(2,'0');
          const m = String(Math.floor((timeMs%3600000)/60000)).padStart(2,'0');
          const s = String(Math.floor((timeMs%60000)/1000)).padStart(2,'0');
          timeStr = `${h}:${m}:${s}`;
        }
      }
      return { dossard, timeMs, timeStr, ...participant };
    });

    // Calculer positions Scratch, Genre, Cat
    const scratch = {}, genrePos = {}, catPos = {};
    const courseCounts = {};
    scanData.forEach(p => {
      courseCounts[p.course] = (courseCounts[p.course]||0)+1;
      scratch[p.dossard] = courseCounts[p.course];

      const keyG = p.course+"_"+p.genre;
      genrePos[keyG] = genrePos[keyG] || 0;
      genrePos[keyG]++;
      p.posGenre = genrePos[keyG];

      const keyC = p.course+"_"+p.categorie;
      catPos[keyC] = catPos[keyC] || 0;
      catPos[keyC]++;
      p.posCat = catPos[keyC];

      p.scratch = scratch[p.dossard];
    });

    renderTable();
  }

  function renderTable() {
    const tbody = document.querySelector("#classement tbody");
    tbody.innerHTML = "";
    // Tri selon configuration
    const sorted = [...scanData].sort((a,b) => {
      let vA = a[sortConfig.key];
      let vB = b[sortConfig.key];
      if(typeof vA==='string') vA=vA.toLowerCase();
      if(typeof vB==='string') vB=vB.toLowerCase();
      if(vA < vB) return sortConfig.direction==="asc" ? -1 : 1;
      if(vA > vB) return sortConfig.direction==="asc" ? 1 : -1;
      return 0;
    });
    sorted.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.dossard}</td>
        <td>${p.nom||""}</td>
        <td>${p.prenom||""}</td>
        <td>${p.timeStr}</td>
        <td>${p.course||""}</td>
        <td>${p.scratch}</td>
        <td>${p.genre||""}</td>
        <td>${p.posGenre}</td>
        <td>${p.categorie||""}</td>
        <td>${p.posCat}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- Tri au clic ---
  document.querySelectorAll("th").forEach(th => {
    th.addEventListener("click", () => {
      const key = th.textContent.replace(/\s/g,'');
      if(sortConfig.key===key) {
        sortConfig.direction = sortConfig.direction==="asc"?"desc":"asc";
      } else {
        sortConfig.key = key;
        sortConfig.direction="asc";
      }
      document.querySelectorAll("th").forEach(h=>h.classList.remove("asc","desc"));
      th.classList.add(sortConfig.direction);
      renderTable();
    });
  });

  fetchData();
  setInterval(fetchData, 5000); // refresh live
</script>
</body>
</html>
