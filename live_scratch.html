<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Trail Calor Run</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <h1>
    <div class="status-indicator" id="status-indicator" title="Connexion en temps réel active"></div>
  </h1>
  
  <!-- CHRONOMÈTRE -->
  <div id="chrono-container" class="chrono-container">
    <div class="chrono-label">Temps de course</div>
    <div class="chrono-time" id="chrono-time">--:--:--</div>
  </div>
  
  <div id="loading" class="loading">Connexion en temps réel...</div>
  
  <div id="compteurs" class="compteurs" style="display: none;">
    <div class="compteur" id="compteur-10">
      Course 10km : <span id="count-10">0</span> arrivés
    </div>
    <div class="compteur" id="compteur-20">
      Course 20km : <span id="count-20">0</span> arrivés
    </div>
  </div>

  <div class="table-container" id="table-container" style="display: none;">
    <table id="classement">
      <thead>
        <tr>
          <th>Dossard</th>
          <th>Nom</th>
          <th>Prénom</th>
          <th>Temps</th>
          <th>Course</th>
          <th>Scratch</th>
          <th>Genre</th>
          <th>Pos. Genre</th>
          <th>CAT</th>
          <th>Pos. CAT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="error" class="error" style="display: none;"></div>
  
  <div class="last-update" id="last-update" style="display: none;">
    Dernière mise à jour : <span id="update-time">--:--:--</span>
  </div>

  <script>
    // Configuration Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain: "calor-run.firebaseapp.com",
  databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calor-run",
  storageBucket: "calor-run.firebasestorage.app",
  messagingSenderId: "329949291334",
  appId: "1:329949291334:web:c71ef20268c609cf953b47",
  measurementId: "G-YVQPW6JGPK"
};

// Variables globales
let departureTimestamp = null;
let participants = {};
let scans = {};
let currentClassement = [];
let previousCounts = { count10: 0, count20: 0 };
let chronoInterval = null;

// Listeners Firebase
let departureListener = null;
let participantsListener = null;
let scansListener = null;

// Éléments DOM
const elements = {
  loading: document.getElementById('loading'),
  compteurs: document.getElementById('compteurs'),
  tableContainer: document.getElementById('table-container'),
  error: document.getElementById('error'),
  count10: document.getElementById('count-10'),
  count20: document.getElementById('count-20'),
  compteur10: document.getElementById('compteur-10'),
  compteur20: document.getElementById('compteur-20'),
  tbody: document.querySelector('#classement tbody'),
  statusIndicator: document.getElementById('status-indicator'),
  lastUpdate: document.getElementById('last-update'),
  updateTime: document.getElementById('update-time'),
  chronoContainer: document.getElementById('chrono-container'),
  chronoTime: document.getElementById('chrono-time')
};

// Initialisation Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Formatage temps
function formatTime(tempsMs) {
  const tempsSec = Math.floor(tempsMs / 1000);
  const h = Math.floor(tempsSec / 3600).toString().padStart(2, '0');
  const m = Math.floor((tempsSec % 3600) / 60).toString().padStart(2, '0');
  const s = (tempsSec % 60).toString().padStart(2, '0');
  return `${h}:${m}:${s}`;
}

// Chronomètre
function startChrono() {
  if (chronoInterval) clearInterval(chronoInterval);

  if (!departureTimestamp) {
    elements.chronoTime.textContent = "--:--:--";
    elements.chronoTime.classList.add('paused');
    return;
  }

  elements.chronoTime.classList.remove('paused');

  const updateChrono = () => {
    const now = Date.now();
    const elapsed = now - departureTimestamp;

    if (elapsed < 0) {
      const timeToStart = Math.abs(elapsed);
      elements.chronoTime.textContent = `-${formatTime(timeToStart)}`;
      elements.chronoTime.classList.add('paused');
    } else {
      elements.chronoTime.textContent = formatTime(elapsed);
      elements.chronoTime.classList.remove('paused');
    }
  };

  updateChrono();
  chronoInterval = setInterval(updateChrono, 1000);
}

function stopChrono() {
  if (chronoInterval) {
    clearInterval(chronoInterval);
    chronoInterval = null;
  }
  elements.chronoTime.textContent = "--:--:--";
  elements.chronoTime.classList.add('paused');
}

// Dernière mise à jour
function updateLastUpdateTime() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('fr-FR');
  elements.updateTime.textContent = timeStr;
  elements.lastUpdate.style.display = 'block';
}

// Afficher erreur
function showError(message) {
  elements.loading.style.display = 'none';
  elements.error.textContent = message;
  elements.error.style.display = 'block';
  elements.statusIndicator.classList.add('disconnected');
  elements.statusIndicator.title = 'Erreur de connexion';
}

// Créer une ligne du tableau (⚠️ plus de "new-entry")
function createTableRow(participant) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${participant.dossard}</td>
    <td>${participant.nom}</td>
    <td>${participant.prenom}</td>
    <td>${participant.tempsStr}</td>
    <td>${participant.course}</td>
    <td>${participant.scratch}</td>
    <td>${participant.genre}</td>
    <td>${participant.posGenre}</td>
    <td>${participant.categorie}</td>
    <td>${participant.posCat}</td>
  `;
  return tr;
}

// Calcul des positions et compteurs
function calculatePositions(classement) {
  const scratchCounter = {};
  const genreCounter = {};
  const catCounter = {};
  let count10 = 0, count20 = 0;

  classement.forEach(p => {
    const courseStr = String(p.course).trim();
    if (courseStr === '10' || courseStr === '10km' || courseStr === '10 km') count10++;
    else if (courseStr === '20' || courseStr === '20km' || courseStr === '20 km') count20++;

    scratchCounter[p.course] = (scratchCounter[p.course] || 0) + 1;
    p.scratch = scratchCounter[p.course];

    const keyGenre = `${p.course}_${p.genre}`;
    genreCounter[keyGenre] = (genreCounter[keyGenre] || 0) + 1;
    p.posGenre = genreCounter[keyGenre];

    const keyCat = `${p.course}_${p.categorie}`;
    catCounter[keyCat] = (catCounter[keyCat] || 0) + 1;
    p.posCat = catCounter[keyCat];
  });

  return { count10, count20 };
}

// Afficher données
function displayData(classement, count10, count20) {
  // Compteurs
  elements.count10.textContent = count10;
  elements.count20.textContent = count20;
  previousCounts = { count10, count20 };

  // Tableau
  const fragment = document.createDocumentFragment();
  classement.forEach(p => fragment.appendChild(createTableRow(p)));
  elements.tbody.innerHTML = '';
  elements.tbody.appendChild(fragment);

  // UI
  elements.loading.style.display = 'none';
  elements.error.style.display = 'none';
  elements.compteurs.style.display = 'block';
  elements.tableContainer.style.display = 'block';

  elements.statusIndicator.classList.remove('disconnected');
  elements.statusIndicator.title = 'Connexion en temps réel active';

  updateLastUpdateTime();
  currentClassement = [...classement];
}

// Mise à jour classement
function updateClassement() {
  if (!departureTimestamp || Object.keys(scans).length === 0) return;

  try {
    let classement = Object.keys(scans)
      .map(dossard => {
        const scan = scans[dossard];
        const participant = participants[dossard] || {};
        const scanTimestamp = new Date(scan.dateTime).getTime();
        const tempsMs = scanTimestamp - departureTimestamp;

        return {
          dossard,
          nom: participant.nom || '',
          prenom: participant.prenom || '',
          tempsMs,
          tempsStr: formatTime(tempsMs),
          course: participant.course || '',
          genre: participant.genre || '',
          categorie: participant.categorie || ''
        };
      })
      .sort((a, b) => a.tempsMs - b.tempsMs);

    const { count10, count20 } = calculatePositions(classement);

    // On affiche du plus récent au plus ancien
    classement = classement.reverse();

    displayData(classement, count10, count20);

  } catch (error) {
    console.error('Erreur lors du calcul:', error);
    showError(`Erreur de calcul: ${error.message}`);
  }
}

// Listeners Firebase
function setupRealtimeListeners() {
  try {
    departureListener = db.ref('data/depart_course').on('value', snapshot => {
      if (snapshot.exists()) {
        departureTimestamp = new Date(snapshot.val()).getTime();
        startChrono();
        updateClassement();
      } else {
        departureTimestamp = null;
        stopChrono();
      }
    });

    participantsListener = db.ref('participants').on('value', snapshot => {
      participants = snapshot.val() || {};
      updateClassement();
    });

    scansListener = db.ref('scan_dossards').on('value', snapshot => {
      scans = snapshot.val() || {};
      updateClassement();
    });

  } catch (error) {
    console.error('Erreur listeners:', error);
    showError(`Erreur: ${error.message}`);
  }
}

// Nettoyage
function cleanup() {
  if (chronoInterval) clearInterval(chronoInterval);
  if (departureListener) db.ref('data/depart_course').off('value', departureListener);
  if (participantsListener) db.ref('participants').off('value', participantsListener);
  if (scansListener) db.ref('scan_dossards').off('value', scansListener);
}

// Gestion connexion
db.ref('.info/connected').on('value', snapshot => {
  if (snapshot.val() === true) {
    elements.statusIndicator.classList.remove('disconnected');
    elements.statusIndicator.title = 'Connexion en temps réel active';
  } else {
    elements.statusIndicator.classList.add('disconnected');
    elements.statusIndicator.title = 'Connexion perdue';
  }
});

// Init
document.addEventListener('DOMContentLoaded', () => {
  elements.chronoTime.textContent = "--:--:--";
  elements.chronoTime.classList.add('paused');
  setupRealtimeListeners();
});
window.addEventListener('beforeunload', cleanup);
  </script>
</body>
</html>
