<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Trail Calor Run</title>
  
  <!-- CSS + dark mode -->
  <style>
  /* --- Reset et base --- */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui,-apple-system,sans-serif; margin:20px; background:#f9f9f9; color:#222; line-height:1.4; overflow-x:hidden; }
  h1 { text-align:center; margin-bottom:20px; font-size:clamp(1.5rem,4vw,2.5rem); color:#215E99; position:relative; }

  /* --- Status indicator --- */
  .status-indicator { position:absolute; top:0; right:0; width:12px; height:12px; border-radius:50%; background:#4CAF50; box-shadow:0 0 10px rgba(76,175,80,0.6); animation:pulse 2s infinite; }
  .status-indicator.disconnected { background:#f44336; box-shadow:0 0 10px rgba(244,67,54,0.6); }
  @keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.5;} }

  /* --- Chrono --- */
  .chrono-container { text-align:center; margin:20px 0 30px; padding:20px; background:linear-gradient(135deg,#215E99 0%,#E61780 100%); border-radius:15px; color:white; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
  .chrono-label { font-size:clamp(0.9rem,2.5vw,1.1rem); margin-bottom:10px; opacity:0.9; font-weight:500; }
  .chrono-time { font-family:'Courier New',monospace; font-size:clamp(2rem,6vw,3.5rem); font-weight:bold; letter-spacing:0.1em; text-shadow:2px 2px 4px rgba(0,0,0,0.3); display:inline-block; min-width:8em; animation:chronoPulse 2s ease-in-out infinite; }
  .chrono-time.paused { animation:none; opacity:0.7; }
  @keyframes chronoPulse { 0%,100%{transform:scale(1);}50%{transform:scale(1.03);} }

  /* --- Compteurs --- */
  .compteurs { text-align:center; margin-bottom:30px; font-size:clamp(0.9rem,2.5vw,1.1rem); font-weight:bold; }
  .compteur { display:inline-block; margin:5px 10px; padding:10px 15px; color:white; border-radius:5px; min-width:120px; }
  .compteur:nth-child(1){background:#215E99;}
  .compteur:nth-child(2){background:#E61780;}

  /* --- Tableau --- */
  .table-container { overflow-x:auto; margin-bottom:40px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
  table { width:100%; border-collapse:collapse; background:white; min-width:800px; }
  th,td{border:1px solid #ddd; padding:8px; text-align:center; font-size:0.9rem;}
  th{background:linear-gradient(135deg,#215E99 0%,#E61780 100%); color:#fff; font-weight:bold; position:sticky; top:0; z-index:10;}
  tbody tr:nth-child(odd){background:#fff;}
  tbody tr:nth-child(even){background:#f2f2f2;}

  /* --- Messages --- */
  .loading, .error, .last-update { text-align:center; margin:40px 0; font-size:1rem; }
  .loading{color:#666;}
  .error{color:#d32f2f; font-weight:bold; padding:20px; background:#ffebee; border-radius:8px;}
  .last-update{color:#666; font-size:0.9rem; margin-top:20px;}
  .last-update a{color:#215E99; text-decoration:underline; margin-left:5px; cursor:pointer;}

  /* --- Responsive --- */
  @media(max-width:768px){
    body{margin:10px;}
    .compteur{display:block;margin:5px auto; max-width:200px;}
    th,td{padding:6px;font-size:0.8rem;}
  }

  /* --- Dark mode automatique --- */
  @media(prefers-color-scheme:dark){
    body{background:#121212;color:#eee;}
    .chrono-container{box-shadow:0 4px 15px rgba(0,0,0,0.6);}
    table{background:#1e1e1e;color:#ddd;}
    th{background:linear-gradient(135deg,#3a7bd5 0%,#e61880 100%);}
    tbody tr:nth-child(odd){background:#1e1e1e;}
    tbody tr:nth-child(even){background:#2a2a2a;}
    .error{background:#3a1a1a;color:#ffaaaa;}
    .last-update a{color:#4aa3ff;}
  }

  /* --- Forced dark/light classes --- */
  body.dark{background:#121212;color:#eee;}
  body.dark table{background:#1e1e1e;color:#ddd;}
  body.dark th{background:linear-gradient(135deg,#3a7bd5 0%,#e61880 100%);}
  body.dark tbody tr:nth-child(odd){background:#1e1e1e;}
  body.dark tbody tr:nth-child(even){background:#2a2a2a;}
  body.dark .error{background:#3a1a1a;color:#ffaaaa;}
  body.dark .last-update a{color:#4aa3ff;}
  body.light{background:#f9f9f9;color:#222;}
  body.light table{background:#fff;color:#222;}
  body.light th{background:linear-gradient(135deg,#215E99 0%,#E61780 100%);}
  body.light tbody tr:nth-child(odd){background:#fff;}
  body.light tbody tr:nth-child(even){background:#f2f2f2;}
  body.light .error{background:#ffebee;color:#d32f2f;}
  body.light .last-update a{color:#215E99;}
  </style>
</head>
<body>
  <h1>
    Live Trail Calor Run
    <div class="status-indicator" id="status-indicator" title="Connexion en temps réel active"></div>
  </h1>

  <!-- Chrono -->
  <div id="chrono-container" class="chrono-container">
    <div class="chrono-label">Temps de course</div>
    <div class="chrono-time" id="chrono-time">--:--:--</div>
  </div>

  <div id="loading" class="loading">Connexion en temps réel...</div>

  <div id="compteurs" class="compteurs" style="display:none;">
    <div class="compteur" id="compteur-10">
      Course 10km : <span id="count-10">0</span> arrivés
    </div>
    <div class="compteur" id="compteur-20">
      Course 20km : <span id="count-20">0</span> arrivés
    </div>
  </div>

  <div class="table-container" id="table-container" style="display:none;">
    <table id="classement">
      <thead>
        <tr>
          <th>Dossard</th><th>Nom</th><th>Prénom</th><th>Temps</th><th>Course</th><th>Scratch</th><th>Genre</th><th>Pos. Genre</th><th>CAT</th><th>Pos. CAT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="error" class="error" style="display:none;"></div>

  <p class="last-update" id="last-update" style="display:none;">
    Dernière mise à jour : <span id="update-time">--:--:--</span>
    · <a href="#" id="theme-toggle">Basculer thème</a>
  </p>

  <!-- Firebase + JS -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
  // --- Theme toggle ---
  const toggleBtn=document.getElementById("theme-toggle");
  const body=document.body;
  const savedTheme=localStorage.getItem("theme");
  if(savedTheme) body.classList.add(savedTheme);
  toggleBtn.addEventListener("click", e=>{
    e.preventDefault();
    if(body.classList.contains("dark")){body.classList.remove("dark"); body.classList.add("light"); localStorage.setItem("theme","light");}
    else if(body.classList.contains("light")){body.classList.remove("light"); localStorage.removeItem("theme");}
    else{body.classList.add("dark"); localStorage.setItem("theme","dark");}
  });

  // --- Firebase config ---
  const firebaseConfig={
    apiKey:"AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
    authDomain:"calor-run.firebaseapp.com",
    databaseURL:"https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"calor-run",
    storageBucket:"calor-run.firebasestorage.app",
    messagingSenderId:"329949291334",
    appId:"1:329949291334:web:c71ef20268c609cf953b47",
    measurementId:"G-YVQPW6JGPK"
  };
  const app=firebase.initializeApp(firebaseConfig);
  const db=firebase.database();

  // --- Variables ---
  let departureTimestamp=null, participants={}, scans={}, currentClassement=[], previousCounts={count10:0,count20:0}, chronoInterval=null;
  let departureListener=null, participantsListener=null, scansListener=null;

  const elements={
    loading:document.getElementById('loading'),
    compteurs:document.getElementById('compteurs'),
    tableContainer:document.getElementById('table-container'),
    error:document.getElementById('error'),
    count10:document.getElementById('count-10'),
    count20:document.getElementById('count-20'),
    compteur10:document.getElementById('compteur-10'),
    compteur20:document.getElementById('compteur-20'),
    tbody:document.querySelector('#classement tbody'),
    statusIndicator:document.getElementById('status-indicator'),
    lastUpdate:document.getElementById('last-update'),
    updateTime:document.getElementById('update-time'),
    chronoContainer:document.getElementById('chrono-container'),
    chronoTime:document.getElementById('chrono-time')
  };

  // --- Fonctions utilitaires ---
  function formatTime(ms){
    const s=Math.floor(ms/1000), h=Math.floor(s/3600).toString().padStart(2,'0'), m=Math.floor((s%3600)/60).toString().padStart(2,'0'), sec=(s%60).toString().padStart(2,'0');
    return `${h}:${m}:${sec}`;
  }
  function startChrono(){if(chronoInterval) clearInterval(chronoInterval); if(!departureTimestamp){elements.chronoTime.textContent="--:--:--"; elements.chronoTime.classList.add('paused'); return;}
    elements.chronoTime.classList.remove('paused');
    const updateChrono=()=>{const now=Date.now(), elapsed=now-departureTimestamp; elements.chronoTime.textContent=elapsed<0?`-${formatTime(Math.abs(elapsed))}`:formatTime(elapsed); elements.chronoTime.classList.toggle('paused', elapsed<0);};
    updateChrono(); chronoInterval=setInterval(updateChrono,1000);
  }
  function stopChrono(){if(chronoInterval){clearInterval(chronoInterval);chronoInterval=null;} elements.chronoTime.textContent="--:--:--"; elements.chronoTime.classList.add('paused');}

  function updateLastUpdateTime(){const now=new Date(); elements.updateTime.textContent=now.toLocaleTimeString('fr-FR'); elements.lastUpdate.style.display='block';}
  function showError(msg){elements.loading.style.display='none'; elements.error.textContent=msg; elements.error.style.display='block'; elements.statusIndicator.classList.add('disconnected'); elements.statusIndicator.title='Erreur de connexion';}

  function createTableRow(p){const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.dossard}</td><td>${p.nom}</td><td>${p.prenom}</td><td>${p.tempsStr}</td><td>${p.course}</td><td>${p.scratch}</td><td>${p.genre}</td><td>${p.posGenre}</td><td>${p.categorie}</td><td>${p.posCat}</td>`; return tr;}
  function calculatePositions(classement){let count10=0,count20=0, scratchCounter={}, genreCounter={}, catCounter={}; classement.forEach(p=>{const c=String(p.course).trim(); if(c==='10'||c==='10km'||c==='10 km') count10++; else if(c==='20'||c==='20km'||c==='20 km') count20++; scratchCounter[p.course]=(scratchCounter[p.course]||0)+1; p.scratch=scratchCounter[p.course]; const keyG=`${p.course}_${p.genre}`; genreCounter[keyG]=(genreCounter[keyG]||0)+1; p.posGenre=genreCounter[keyG]; const keyC=`${p.course}_${p.categorie}`; catCounter[keyC]=(catCounter[keyC]||0)+1; p.posCat=catCounter[keyC];}); return {count10,count20}; }
  function displayData(classement,count10,count20){const fragment=document.createDocumentFragment(); classement.forEach(p=>fragment.appendChild(createTableRow(p))); elements.tbody.innerHTML=''; elements.tbody.appendChild(fragment); elements.loading.style.display='none'; elements.error.style.display='none'; elements.compteurs.style.display='block'; elements.tableContainer.style.display='block'; elements.statusIndicator.classList.remove('disconnected'); elements.statusIndicator.title='Connexion en temps réel active'; updateLastUpdateTime(); previousCounts={count10,count20}; currentClassement=[...classement]; }

  function updateClassement(){if(!departureTimestamp||Object.keys(scans).length===0) return; try{let classement=Object.keys(scans).map(dossard=>{const scan=scans[dossard],p=participants[dossard]||{}; const t=new Date(scan.dateTime).getTime(), elapsed=t-departureTimestamp; return {dossard,nom:p.nom||'',prenom:p.prenom||'',tempsMs:elapsed,tempsStr:formatTime(elapsed),course:p.course||'',genre:p.genre||'',categorie:p.categorie||''};}).sort((a,b)=>a.tempsMs-b.tempsMs); const {count10,count20}=calculatePositions(classement); classement=classement.reverse(); displayData(classement,count10,count20);}catch(e){console.error(e); showError(`Erreur de calcul: ${e.message}`);} }

  // --- Firebase listeners ---
  function setupRealtimeListeners(){
    departureListener=db.ref('data/depart_course').on('value',snap=>{if(snap.exists()){departureTimestamp=new Date(snap.val()).getTime(); startChrono(); updateClassement();}else{departureTimestamp=null; stopChrono();}});
    participantsListener=db.ref('participants').on('value',snap=>{participants=snap.val()||{}; updateClassement();});
    scansListener=db.ref('scan_dossards').on('value',snap=>{scans=snap.val()||{}; updateClassement();});
  }
  function cleanup(){if(chronoInterval){clearInterval(chronoInterval);chronoInterval=null;} if(departureListener) db.ref('data/depart_course').off('value',departureListener); if(participantsListener) db.ref('participants').off('value',participantsListener); if(scansListener) db.ref('scan_dossards').off('value',scansListener);}
  
  db.ref('.info/connected').on('value',snap=>{if(snap.val()===true){elements.statusIndicator.classList.remove('disconnected'); elements.statusIndicator.title='Connexion en temps réel active';}else{elements.statusIndicator.classList.add('disconnected'); elements.statusIndicator.title='Connexion perdue - Tentative de reconnexion...';}});

  document.addEventListener('DOMContentLoaded',()=>{elements.chronoTime.textContent="--:--:--"; elements.chronoTime.classList.add('paused'); setupRealtimeListeners();});
  window.addEventListener('beforeunload',cleanup);
  </script>
</body>
</html>
