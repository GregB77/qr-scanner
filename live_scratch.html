<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Classement Course - Moderne</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <style>
    body { font-family: 'Arial', sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 20px; }
    #classement_wrapper { max-width: 1200px; margin: 0 auto; }
    table.dataTable tbody tr:nth-child(even) { background: #f2f2f2; }
    table.dataTable thead { background: #0077cc; color: #fff; }
    table.dataTable tbody td { vertical-align: middle; }
  </style>
</head>
<body>
  <h1>Classement Course</h1>
  <table id="classement" class="display stripe hover">
    <thead>
      <tr>
        <th>Dossard</th>
        <th>Nom</th>
        <th>Prénom</th>
        <th>Temps</th>
        <th>Course</th>
        <th>Scratch</th>
        <th>Genre</th>
        <th>Pos. Genre</th>
        <th>CAT</th>
        <th>Pos. CAT</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.firebasestorage.app",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47",
      measurementId: "G-YVQPW6JGPK"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let departCourses = {};
    let participants = {};
    let scans = {};

    // --- Conversion robuste des dates ---
    function parseScanDate(scanDate) {
      if (!scanDate) return null;

      // Si c’est un objet Date
      if (scanDate instanceof Date) return scanDate.toISOString();

      // Si c’est un nombre (timestamp)
      if (typeof scanDate === 'number') return new Date(scanDate).toISOString();

      // Si c’est une chaîne
      if (typeof scanDate === 'string') {
        if (!scanDate.endsWith("Z")) {
          const parts = scanDate.split(/[/ :]/);
          if (parts.length === 6) {
            const [dd, mm, yyyy, hh, min, ss] = parts;
            return `${yyyy}-${mm}-${dd}T${hh}:${min}:${ss}Z`;
          }
        }
        return scanDate; // déjà ISO
      }

      return null;
    }

    // --- Calcul du classement ---
    function calculateClassement() {
      let classement = Object.keys(scans).map(dossard => {
        const scan = scans[dossard];
        const participant = participants[dossard] || {};
        const course = participant.course || "";
        const departCourseStr = departCourses[course];
        let tempsMs = Infinity;
        let tempsStr = "--:--:--";

        if (departCourseStr) {
          const departureTime = new Date(departCourseStr).getTime();
          const scanTimeISO = parseScanDate(scan.dateTime);
          const dt = new Date(scanTimeISO);
          if (!isNaN(dt)) {
            tempsMs = dt.getTime() - departureTime;
            const tempsSec = Math.floor(tempsMs / 1000);
            const h = Math.floor(tempsSec / 3600).toString().padStart(2,'0');
            const m = Math.floor((tempsSec % 3600) / 60).toString().padStart(2,'0');
            const s = (tempsSec % 60).toString().padStart(2,'0');
            tempsStr = `${h}:${m}:${s}`;
          }
        }

        return {
          dossard,
          nom: participant.nom || '',
          prenom: participant.prenom || '',
          tempsMs,
          tempsStr,
          course,
          genre: participant.genre || '',
          categorie: participant.categorie || ''
        };
      });

      // Filtrer et trier
      classement = classement.filter(p => p.tempsMs !== Infinity);
      classement.sort((a,b) => a.tempsMs - b.tempsMs);

      // Calcul positions
      const scratchCounter = {};
      const genreCounter = {};
      const catCounter = {};

      classement.forEach(p => {
        scratchCounter[p.course] = (scratchCounter[p.course] || 0) + 1;
        p.scratch = scratchCounter[p.course];

        const keyGenre = `${p.course}_${p.genre}`;
        genreCounter[keyGenre] = (genreCounter[keyGenre] || 0) + 1;
        p.posGenre = genreCounter[keyGenre];

        const keyCat = `${p.course}_${p.categorie}`;
        catCounter[keyCat] = (catCounter[keyCat] || 0) + 1;
        p.posCat = catCounter[keyCat];
      });

      return classement;
    }

    // --- Rendu du tableau ---
    function renderTable() {
      const classement = calculateClassement();
      const table = $('#classement').DataTable();
      table.clear();

      classement.forEach(p => {
        table.row.add([
          p.dossard, p.nom, p.prenom, p.tempsStr, p.course,
          p.scratch, p.genre, p.posGenre, p.categorie, p.posCat
        ]);
      });

      table.draw();
    }

    // --- Initialisation DataTable et listeners Firebase ---
    $(document).ready(function() {
      $('#classement').DataTable({
        paging: false,
        info: false,
        searching: false,
        order: [[3,'asc']], // trier par temps initial
        columnDefs: [
          { targets: [3,5,7,9], type: 'num' } // colonnes numériques
        ]
      });

      // Écoute temps réel Firebase
      db.ref('data/depart_courses').on('value', snapshot => {
        departCourses = snapshot.val() || {};
        renderTable();
      });

      db.ref('participants').on('value', snapshot => {
        participants = snapshot.val() || {};
        renderTable();
      });

      db.ref('scans_dossards').on('value', snapshot => {
        scans = snapshot.val() || {};
        renderTable();
      });

      // Sécurité : refresh toutes les 15s si nécessaire
      setInterval(renderTable, 15000);
    });
  </script>
</body>
</html>
