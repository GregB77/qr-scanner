<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
    authDomain: "calor-run.firebaseapp.com",
    databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "calor-run",
    storageBucket: "calor-run.firebasestorage.app",
    messagingSenderId: "329949291334",
    appId: "1:329949291334:web:c71ef20268c609cf953b47",
    measurementId: "G-YVQPW6JGPK"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Heure de départ (9h00)
  const departureTime = new Date();
  departureTime.setHours(9,0,0,0);
  const departureTimestamp = departureTime.getTime();

  const tbody = document.querySelector("#classement tbody");
  const statsDiv = document.getElementById("stats");

  // Compteurs
  const scratchCounter = {};
  const genreCounter = {};
  const catCounter = {};
  const courseCounts = {};

  // Cache limité à 500
  let cache = JSON.parse(localStorage.getItem("classement_cache") || "[]");
  let participants = {};

  // --- Fonction d’affichage ---
  function afficherCoureur(dossard, scan) {
    const participant = participants[dossard];
    if (!participant) return; // sécurité : ignorer si participant inconnu

    const tempsMs = new Date(scan.dateTime).getTime() - departureTimestamp;
    const tempsSec = Math.floor(tempsMs / 1000);
    const h = Math.floor(tempsSec / 3600).toString().padStart(2,'0');
    const m = Math.floor((tempsSec % 3600) / 60).toString().padStart(2,'0');
    const s = (tempsSec % 60).toString().padStart(2,'0');

    // Scratch général par course
    scratchCounter[participant.course] = (scratchCounter[participant.course] || 0) + 1;
    const scratch = scratchCounter[participant.course];

    // Pos. Genre
    const keyGenre = `${participant.course}_${participant.genre}`;
    genreCounter[keyGenre] = (genreCounter[keyGenre] || 0) + 1;
    const posGenre = genreCounter[keyGenre];

    // Pos. CAT
    const keyCat = `${participant.course}_${participant.categorie}`;
    catCounter[keyCat] = (catCounter[keyCat] || 0) + 1;
    const posCat = catCounter[keyCat];

    // Compteurs par course
    courseCounts[participant.course] = (courseCounts[participant.course] || 0) + 1;
    statsDiv.textContent = `10 km : ${courseCounts["10km"] || 0} arrivés | 20 km : ${courseCounts["20km"] || 0} arrivés`;

    // Ajouter au tableau
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${dossard}</td>
      <td>${participant.nom || ""}</td>
      <td>${participant.prenom || ""}</td>
      <td>${h}:${m}:${s}</td>
      <td>${participant.course || ""}</td>
      <td>${scratch}</td>
      <td>${participant.genre || ""}</td>
      <td>${posGenre}</td>
      <td>${participant.categorie || ""}</td>
      <td>${posCat}</td>
    `;
    tbody.prepend(tr);
  }

  // --- Étape 1 : Charger participants ---
  db.ref("participants").once("value").then(snap => {
    participants = snap.val() || {};

    // --- Étape 2 : Rejouer le cache une fois participants connus ---
    cache.forEach(entry => afficherCoureur(entry.dossard, entry.scan));

    // --- Étape 3 : Activer l’écoute temps réel ---
    db.ref("scan_dossards").on("child_added", snap => {
      const dossard = snap.key;
      const scan = snap.val();

      afficherCoureur(dossard, scan);

      // Mettre à jour le cache
      cache.push({ dossard, scan });
      if (cache.length > 500) cache.shift();
      localStorage.setItem("classement_cache", JSON.stringify(cache));
    });
  });
</script>
