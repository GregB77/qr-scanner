<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Classement Course</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; margin-bottom: 10px; }
    #departs { text-align: center; margin-bottom: 20px; font-size: 1.1em; color: #444; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #0077cc; color: #fff; }
    tbody tr:nth-child(even) { background: #f2f2f2; }
  </style>
</head>
<body>
  <h1>Classement Course</h1>
  <div id="departs">Chargement des heures de départ...</div>
  <table id="classement">
    <thead>
      <tr>
        <th>Dossard</th>
        <th>Nom</th>
        <th>Prénom</th>
        <th>Temps</th>
        <th>Course</th>
        <th>Scratch</th>
        <th>Genre</th>
        <th>Pos. Genre</th>
        <th>CAT</th>
        <th>Pos. CAT</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.firebasestorage.app",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47",
      measurementId: "G-YVQPW6JGPK"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let departCourses = {};
    let participants = {};
    let scans = {};

    function parseScanDate(scanDate) {
      // Si déjà ISO, ok
      if (!scanDate) return null;
      if (!scanDate.endsWith("Z")) {
        // convertit format "DD/MM/YYYY HH:MM:SS" en ISO
        const parts = scanDate.split(/[/ :]/);
        if (parts.length === 6) {
          const [dd, mm, yyyy, hh, min, ss] = parts;
          return `${yyyy}-${mm}-${dd}T${hh}:${min}:${ss}Z`;
        }
      }
      return scanDate;
    }

    function renderClassement() {
      const tbody = document.querySelector("#classement tbody");
      tbody.innerHTML = "";

      let classement = Object.keys(scans).map(dossard => {
        const scan = scans[dossard];
        const participant = participants[dossard] || {};

        const course = participant.course || "";
        const departCourseStr = departCourses[course];
        let tempsMs = Infinity;
        let tempsStr = "--:--:--";

        if (departCourseStr) {
          const departureTime = new Date(departCourseStr).getTime();
          const scanTimeISO = parseScanDate(scan.dateTime);
          const dt = new Date(scanTimeISO);
          if (!isNaN(dt)) {
            tempsMs = dt.getTime() - departureTime;
            const tempsSec = Math.floor(tempsMs / 1000);
            const h = Math.floor(tempsSec / 3600).toString().padStart(2,'0');
            const m = Math.floor((tempsSec % 3600) / 60).toString().padStart(2,'0');
            const s = (tempsSec % 60).toString().padStart(2,'0');
            tempsStr = `${h}:${m}:${s}`;
          }
        }

        return {
          dossard,
          nom: participant.nom || '',
          prenom: participant.prenom || '',
          tempsMs,
          tempsStr,
          course,
          genre: participant.genre || '',
          categorie: participant.categorie || ''
        };
      });

      classement = classement.filter(p => p.tempsMs !== Infinity);
      classement.sort((a,b) => a.tempsMs - b.tempsMs);

      // Calcul positions
      const scratchCounter = {};
      const genreCounter = {};
      const catCounter = {};

      classement.forEach(p => {
        scratchCounter[p.course] = (scratchCounter[p.course] || 0) + 1;
        p.scratch = scratchCounter[p.course];

        const keyGenre = `${p.course}_${p.genre}`;
        genreCounter[keyGenre] = (genreCounter[keyGenre] || 0) + 1;
        p.posGenre = genreCounter[keyGenre];

        const keyCat = `${p.course}_${p.categorie}`;
        catCounter[keyCat] = (catCounter[keyCat] || 0) + 1;
        p.posCat = catCounter[keyCat];
      });

      // Affichage
      classement.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.dossard}</td>
          <td>${p.nom}</td>
          <td>${p.prenom}</td>
          <td>${p.tempsStr}</td>
          <td>${p.course}</td>
          <td>${p.scratch}</td>
          <td>${p.genre}</td>
          <td>${p.posGenre}</td>
          <td>${p.categorie}</td>
          <td>${p.posCat}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Écoute temps réel
    db.ref('data/depart_courses').on('value', snapshot => {
      departCourses = snapshot.val() || {};
      const departsDiv = document.getElementById("departs");

      if (!Object.keys(departCourses).length) {
        departsDiv.innerText = "⚠️ Aucune heure de départ définie";
        return;
      }

      let html = "<b>Heures de départ :</b><br>";
      for (const course in departCourses) {
        const formatted = new Date(departCourses[course]).toLocaleString("fr-FR", {
          timeZone: "Europe/Paris",
          dateStyle: "short",
          timeStyle: "medium"
        });
        html += `${course} → ${formatted}<br>`;
      }
      departsDiv.innerHTML = html;
      renderClassement();
    });

    db.ref('participants').on('value', snapshot => {
      participants = snapshot.val() || {};
      renderClassement();
    });

    db.ref('scans_dossards').on('value', snapshot => {
      scans = snapshot.val() || {};
      renderClassement();
    });
  </script>
</body>
</html>
