<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scanner QR Code Final</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    #reader { width: 80vw; margin: 20px auto; }
    #result { font-size: 4em; color: green; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Scanner QR Code Final</h1>
  <div id="reader"></div>
  <div id="result">---</div>

  <script>
    // ===== 1. APPS SCRIPT PROXY =====
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwD-7gP71Nx4aaH2oY-FhFSszSKLgax5q1GdkjSzdBIr5NhxzVbUw3u327S80bnIFN3/exec";

    // ===== 2. CONFIG FIREBASE =====
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.firebasestorage.app",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47",
      measurementId: "G-YVQPW6JGPK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== 3. INITIALISATION SCANNER =====
    const html5QrCode = new Html5Qrcode("reader");
    const queue = [];
    let sending = false;

    function onScanSuccess(decodedText) {
      const code = String(decodedText || "").trim();
      console.log("Scan détecté:", code);
      document.getElementById("result").innerText = code;

      queue.push(code);
      processQueue();
    }

    function onScanFailure(error) {
      // console.log("Scan raté:", error);
    }

    function processQueue() {
      if (sending || queue.length === 0) return;
      sending = true;
      const code = queue.shift();

      // ----- ENVOI APPS SCRIPT -----
      fetch(APP_SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code })
      })
      .then(r => r.json())
      .then(res => {
        console.log("Réponse Apps Script:", res);
        if (res.status === "duplicate") console.warn("Doublon détecté :", code);
        if (res.status !== "ok" && res.status !== "duplicate") queue.push(code);
      })
      .catch(err => {
        console.error("Erreur Apps Script:", err);
        queue.push(code);
      });

      // ----- ENVOI FIREBASE -----
      const timestamp = Date.now();
      db.ref('scans/' + timestamp).set({ code })
        .then(() => console.log("Envoyé Firebase:", code))
        .catch(err => {
          console.error("Erreur Firebase:", err);
          queue.push(code);
        })
        .finally(() => {
          sending = false;
          if (queue.length > 0) processQueue();
        });
    }

    // ===== 4. LANCEMENT CAMERA =====
    Html5Qrcode.getCameras().then(cameras => {
      if (!cameras || cameras.length === 0) {
        console.error("Aucune caméra détectée !");
        return;
      }
      const rear = cameras.find(c => c.label.toLowerCase().includes("back")) || cameras[0];
      html5QrCode.start(
        rear.id,
        { fps: 10, qrbox: { width: 300, height: 300 }, facingMode: "environment" },
        onScanSuccess,
        onScanFailure
      );
    });
  </script>
</body>
</html>
