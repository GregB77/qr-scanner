<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Participants Calor Run</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏱️</text></svg>">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .counters {
      margin: 15px 0 25px 0;
      display: flex;
      justify-content: center;
      gap: 30px;
      font-size: 18px;
      font-weight: bold;
    }
    .counter {
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .c10 { background: #d4f8d4; color: #2e7d32; }
    .c20 { background: #d4e3f8; color: #1e40af; }
    .ctotal { background: #f0f0f0; color: #333; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    thead {
      background: #4CAF50;
      color: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
    }
    th {
      cursor: pointer;
      position: relative;
      user-select: none;
    }
    tr:nth-child(even) {
      background: #f2f2f2;
    }
    tr:hover {
      background: #e9ffe9;
    }
    .arrow {
      font-size: 12px;
      margin-left: 5px;
    }
    .center {
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Participants Calor Run</h1>

  <!-- Compteurs -->
  <div class="counters">
    <div class="counter c10">10 km : <span id="count10">0</span></div>
    <div class="counter c20">20 km : <span id="count20">0</span></div>
    <div class="counter ctotal">Total : <span id="countTotal">0</span></div>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th data-column="Dossard" class="center">Dossard <span class="arrow"></span></th>
        <th data-column="Nom">Nom <span class="arrow"></span></th>
        <th data-column="Prenom">Prénom <span class="arrow"></span></th>
        <th data-column="Club">Club <span class="arrow"></span></th>
        <th data-column="Age">Age <span class="arrow"></span></th>
        <th data-column="HF" class="center">H/F <span class="arrow"></span></th>
        <th data-column="CAT" class="center">CAT <span class="arrow"></span></th>
        <th data-column="Course" class="center">Course <span class="arrow"></span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.firebasestorage.app",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47",
      measurementId: "G-YVQPW6JGPK"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function formatExcelDate(excelDate) {
      const jsDate = new Date((excelDate - 25569) * 86400 * 1000);
      const day = String(jsDate.getDate()).padStart(2, '0');
      const month = String(jsDate.getMonth() + 1).padStart(2, '0');
      const year = jsDate.getFullYear();
      return `${day}/${month}/${year}`;
    }

    const tbody = document.querySelector("#dataTable tbody");
    const count10 = document.getElementById("count10");
    const count20 = document.getElementById("count20");
    const countTotal = document.getElementById("countTotal");

    db.ref("participants").on("value", snapshot => {
      const data = snapshot.val();
      tbody.innerHTML = "";

      let total = 0, c10 = 0, c20 = 0;

      Object.values(data).forEach(row => {
        total++;
        if (row.Course == "10") c10++;
        if (row.Course == "20") c20++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="center">${row.Dossard}</td>
          <td>${row.Nom}</td>
          <td>${row.Prenom}</td>
          <td>${row.Club}</td>
          <td>${formatExcelDate(row.Age)}</td>
          <td class="center">${row.HF}</td>
          <td class="center">${row.CAT}</td>
          <td class="center">${row.Course}</td>
        `;
        tbody.appendChild(tr);
      });

      // maj compteurs
      count10.textContent = c10;
      count20.textContent = c20;
      countTotal.textContent = total;
    });

    // Tri simple asc/desc
    const headers = document.querySelectorAll("th");
    let sortOrder = {};

    headers.forEach(header => {
      header.addEventListener("click", () => {
        const column = header.dataset.column;
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const isAsc = sortOrder[column] !== true;

        rows.sort((a, b) => {
          let valA = a.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText;
          let valB = b.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText;

          if (!isNaN(valA) && !isNaN(valB)) {
            return isAsc ? valA - valB : valB - valA;
          }
          return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });

        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));
        sortOrder[column] = isAsc;

        document.querySelectorAll(".arrow").forEach(a => a.innerText = "");
        header.querySelector(".arrow").innerText = isAsc ? "▲" : "▼";
      });
    });
  </script>
</body>
</html>
